> 🔗 原文链接： [https://blog.csdn.net/BF02jgtRS00XK...](https://blog.csdn.net/BF02jgtRS00XKtCx/article/details/107218146)

> ⏰ 剪存时间：2023-03-24 16:04:11 (UTC+8)

> ✂️ 本文档由 [飞书剪存 ](https://www.feishu.cn/hc/zh-CN/articles/606278856233?from=in_ccm_clip_doc)一键生成

# 用 Python 对数据进行相关性分析

在进行数据分析时，我们所用到的数据往往都不是一维的，而这些数据在分析时难度就增加了不少，因为我们需要考虑维度之间的关系。而这些维度关系的分析就需要用一些方法来进行衡量，相关性分析就是其中一种。本文就用python来解释一下数据的相关性分析。

在进行相关性分析之前需要介绍几个概念，一是维度，二是协方差，三是相关系数。首先来看维度，以图1为例，这是一个员工信息统计表，这里有n个员工，分别是员工1、员工2、......、员工n，每个员工有5个属性，分别是身高、体重、年龄、工龄和学历。每个员工的信息都是一个观测，也叫一个样品，本文就统称观测，每个员工的一个属性叫一个指标，也叫变量、维度或者属性，本文统称维度。所以这个图中就有n个观测和5个维度。

![](https://fjjwhjwd3p.feishu.cn/space/api/box/stream/download/asynccode/?code=NjIwYjJmM2U1Yzg2NDhhMDFjNWRkZWRjZTc1ZDBlZGNfREJYNmhSZHVkZzhpVDI1VkZPU0I2Z3VBQzZvR0FLUmlfVG9rZW46VkRGRmJJQkk5b2UwdVh4QW9XTWMwNDdJbjlnXzE2Nzk2NDUwNzU6MTY3OTY0ODY3NV9WNA)

图1. 员工信息表

而协方差的定义就是 `E{ [ X - E(X) ] [ Y - E(Y) ] }` ，记作 `Cov(X, Y)` ，也就是两个维度与各自期望之差的乘积的期望，期望在离散型数据中通常是均值，比如图1中身高代表X，体重代表Y， `E(X)` 就是身高的均值， `E(Y)` 就是体重的均值，在利用二者分别和 `E(X)` 与 `E(Y)` 的差求协方差。而相关系数就是 `Cov(X, Y)/[σ(X)σ(Y)]` ，记作 `ρXY` ，其中 `σ(X)` 和 `σ(Y)` 分别表示X和Y的标准差，所以相关系数就是两个变量的协方差除以其标准差之积。类似的，假如某个观测有p个维度，计算每个维度同所有维度之间的协方差，则会形成一个 `pxp` 的矩阵，矩阵的每个数是其相应维度之间的协方差，这个矩阵就称为协方差矩阵，协方差矩阵按照上面的方法再进一步计算就可得到相关关系矩阵。

下面就以python代码来解释一下相关性分析。

首先是数据集，本文用的数据来自绘图库seaborn自带的数据，是非常著名的鸢尾花的数据，获取方式非常简单，执行下面代码即可。这里有一个问题要提示一下，部分人在 `load_dataset` 时会出错，无法读取数据，是因为iris这个数据集不存在，这可能是因为seaborn版本的问题，如果遇到这种情况，可以去seaborn的GitHub数据网站自行下载数据，网址是 `https://github.com/mwaskom/seaborn-data` ，把下载的数据解压到seaborn-data文件夹即可，这个文件夹一般在seaborn安装目录下或者是当前工作目录下。

```Go
import seaborn as sns
data = sns.load_dataset('iris')
df = data.iloc[:, :4] #取前四列数据
```

这次用到的数据集共有150行、5列，我们只用到前4列数据。数据集样例如图2所示。

![](https://fjjwhjwd3p.feishu.cn/space/api/box/stream/download/asynccode/?code=NWZkNjE3OWNhNmI0NTNiZTg5N2RkZGZlNDRmYzhiZjlfdDY5c2NyRmxHcEJMVVFVeFIzSEczcmdCTzFCZDhCMXpfVG9rZW46R3d5cGJtVHZsbzd6NTR4bE5lV2NPdFlxbjVlXzE2Nzk2NDUwNzU6MTY3OTY0ODY3NV9WNA)

图2. 数据集样例

接下来我们来进行相关性分析。

首先来做一个比较简单的分析，即分析这个数据集中第1列和第3列的相关性，也就是 `sepal_length` 和 `petal_length` 这两列之间的关系。这里我们可以用 [numpy ](https://so.csdn.net/so/search?q=numpy&spm=1001.2101.3001.7020)、scipy和pandas三种方法。首先是numpy。

```Go
import numpy as np
X = df['sepal_length']
Y = df['petal_length']
result1 = np.corrcoef(X, Y)
```

得到的result1结果就是一个二维矩阵，如图3所示。

![](https://fjjwhjwd3p.feishu.cn/space/api/box/stream/download/asynccode/?code=YjA0ZWYwYzJiMmViYjJjNjU0MmU5YjY5NzBlYzYwM2RfZWUxaHJoRU93S3hsY3JUSEV0dlhUZ01sYzZsamZ4Z0VfVG9rZW46RXJQSWJrTVVRb2w1TXJ4T1BBamN4MFNMbm5iXzE2Nzk2NDUwNzU6MTY3OTY0ODY3NV9WNA)

图3. result1计算结果

其中矩阵主对角线上的数值都为1（主对角线就是从左上角到右下角的那条斜线），这是因为主对角线的数值都是每个观测与自己的相关性，所以都是1，毕竟 `X=1X` ， `Y=1Y` ，每个观测都等于1乘以自身。而图3中其他不为1的数字就是相关关系数值，一共有两个，这两个值相等，因为这两个值分别表示 `ρXY` 和 `ρYX` ，其值相等。同理我们可以求df中4个维度的相关关系，代码如下，这里 `rowvar` 代表以列为维度。

```Go
result2 = np.corrcoef(df, rowvar=False)
```

其结果如图4所示。

![](https://fjjwhjwd3p.feishu.cn/space/api/box/stream/download/asynccode/?code=NTc4Zjk1NmI0MWFhODJhYTdkMTM3YTE1ODQyZTczMjJfYmh5TkV3cHUxY1pMWVZweDNGU3JjcWowWG1aZUlLaUNfVG9rZW46Q2hSbWJua0pob1N1djZ4djRSMWNNVmlFbndlXzE2Nzk2NDUwNzU6MTY3OTY0ODY3NV9WNA)

图4. result2计算结果

图4是一个4x4的矩阵，共16个数据，代表每个维度同其他维度的相关关系（也包括每个维度与其自身），主对角线为1，其他数字关于主对角线对称，是一个对称矩阵。

接下来我们用scipy进行分析。代码如下。

```Go
import scipy.stats as ss
result3 = ss.pearsonr(X, Y)
```

这个结果是 `(0.8717537758865831, 1.0386674194498099e-47)` ，其返回的是两个数，第一个数是X和Y的相关关系数值，其值和前面numpy的计算结果相同，第二个是两者不相关的概率，也就是我们统计学中常说的 `p` 值，但这个值是指不相关的概率，也就是值越小，代表越相关，我们这里的数值非常小，代表二者的线性相关程度比较大。当然如果相关关系数值为1，则 `p` 值为0。scipy中没有计算相关矩阵的方法。

最后是pandas方法。

因为前面的df本身就是pandas的DataFrame格式，所以我们可以直接拿来用。代码如下。

```Go
result4 = X.corr(Y)
result5 = df.corr()
```

result4结果是0.8717537758865833，result5结果如图5所示。这两个结果和前面所得的结果相同。

![](https://fjjwhjwd3p.feishu.cn/space/api/box/stream/download/asynccode/?code=ZGRkZTNhODJlN2Q4ZGQyMTUyOTQxZTBjYTViMzAwYzZfSnZRUjlzT05hQ2N1V1NGNDJEck1zMmtQYmpXV2dMSW1fVG9rZW46SmQ3c2JRdWo1b1F3aVZ4NnNhWmN2ckpJbnJmXzE2Nzk2NDUwNzU6MTY3OTY0ODY3NV9WNA)

图5. result5计算结果

接下来是作图。对于分析相关关系，一般有两种常见的图形，一种是散点图，一种是热力图。散点图中可以清晰看到各个坐标点的分布及趋势，对于数据分析者而言，其可以更直观地了解各个维度数据之间的关系，但这种方法也有缺点，即不适合大数据量，因为数据量太大，生成图片速度会很慢，同时图片太多不利于观察；而热力图则更多从数值或颜色方面，来准确描述各个维度的关系，其传递的信息较少，但比较适合大数据量。我们首先介绍一下散点图。

生成散点图可以用seaborn或者pandas。seaborn的代码如下。

```Go
sns.pairplot(df)
sns.pairplot(df , hue ='sepal_width');
```

第一行代码结果如图6所示，是一张大图，其中包含16个子图，每个子图都是每个维度和其他某个维度的相关关系图，这其中主对角线上的图，则是每个维度的数据分布直方图。而第二行代码是画出同样的图形，但却以 `sepal_width` 这个维度的数据为标准，来对各个数据点进行着色，其结果如图7所示。从图中可以看出， `sepal_width` 这列数据共23个不同的数值，每个数值一种颜色，所以生成的图是彩色的。

![](https://fjjwhjwd3p.feishu.cn/space/api/box/stream/download/asynccode/?code=MmNkZTFiMzAzNDM3MDVlMzg3MTRmMDI3YzM1MzE4Yjlfa0JXVU1xdVZCdE5zYXBFTFdCZzBlVmYxcm5DMko4TzlfVG9rZW46VldTNGJCelM3b3ZVNFd4VGs3OWM5ZU5SblJiXzE2Nzk2NDUwNzU6MTY3OTY0ODY3NV9WNA)

图6. seaborn绘制的普通相关关系图

![](https://fjjwhjwd3p.feishu.cn/space/api/box/stream/download/asynccode/?code=MWJmOGZlN2YwYmFmYmJkZmJjODJjOTk2OTQ1MTQ3ZWZfaUFMcDRIdHhBTnVhS2xscGNkbWI1aEtNNEtIQzllaVRfVG9rZW46QWhGcGJFY2szb2E2c1B4VlJDNGNYN21wbnpNXzE2Nzk2NDUwNzU6MTY3OTY0ODY3NV9WNA)

图7. seaborn绘制的以某列数据为基准的相关关系图

而另外一种绘图方法是用pandas，其代码如下。

```Go
import pandas as pd
pd.plotting.scatter_matrix(df, figsize=(12,12),range_padding=0.5);
```

结果如图8所示，可以看到用pandas绘制的图和seaborn的大体结果一样，但图片的可定制程度和精细度还是略差一些，所以一般情况下建议用seaborn。

![](https://fjjwhjwd3p.feishu.cn/space/api/box/stream/download/asynccode/?code=MzlmZTIwZTc5OWU1NGRiYWUyMTliYmU2ODBkZjhmYjVfZWZmVUdPWkRiblZNT0g2VHIwSVdvWmNUZWpvaDBPR2tfVG9rZW46S3Y2ZWJ2RWJ4b09YTXl4blVMYmNrNmQ4bnliXzE2Nzk2NDUwNzU6MTY3OTY0ODY3NV9WNA)

图8. pandas生成的相关关系图

最后就是热力图。其代码如下。

```Go
import matplotlib.pyplot as plt
figure, ax = plt.subplots(figsize=(12, 12))
sns.heatmap(df.corr(), square=True, annot=True, ax=ax)
```

刚开始写这段代码时还出现了一个小问题，如图9所示。图9当中第一行和最后一行的子图只显示了一部分，而其他子图都是完整显示，这是matplotlib的一个bug，因为seaborn是基于matplotlib的库，所以只要升级matplotlib就行了，刚开始笔者的matplotlib版本是3.1.1，现在已升级到3.2.2，这个bug已经被修复。正常图如图10所示。第二行代码中 `square=True` 表示每个子图是否以正方形显示，这里设置为 `True` ， `annot=True` 则表示是否在图中显示每个子图的数值，这里同样设置为 `True` 。

![](https://fjjwhjwd3p.feishu.cn/space/api/box/stream/download/asynccode/?code=NWVjMTU5OTVkNTAxYTM4MTNiNzA3N2ZiZDAwYzI5N2NfM244OVFEdm0xRDJUelRjWHg0RklNa203Q2VUZjVGd1ZfVG9rZW46WXg0dmJqWEg5b09uQTB4dHFINmM3WFBIbnJjXzE2Nzk2NDUwNzU6MTY3OTY0ODY3NV9WNA)

图9. 老版本matplotlib生成的热力图

![](https://fjjwhjwd3p.feishu.cn/space/api/box/stream/download/asynccode/?code=Yjk4YmJiOWNiYTEwNTg3M2M4ZDM5MDVlNDdkNTg2YTlfSVd3Z1JLUUZFdXVYZWEyNDJYNzJPR0RqWngxbUlQZmpfVG9rZW46U01iNGJSR1FUb0hPc0l4enZtNmNlSXI3blRiXzE2Nzk2NDUwNzU6MTY3OTY0ODY3NV9WNA)

图10. 新版本matplotlib生成的热力图

本文从数据计算到可视化，介绍了用python求多维数据间的相关关系的多种方法，我们可以根据自己的需求来选择对应的方法。
